<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>动态固件在线安装器 (调试版)</title>
  <meta name="description" content="一个基于文件夹结构动态加载的网页固件安装程序。" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />

  <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>

  <style>
    /* 样式部分保持不变，直接复制即可 */
    :root{--theme-hue:207;--primary-color:hsl(var(--theme-hue),95%,50%);--background-color:#f0f4f8;--text-color:#333;--card-background:#fff;--card-border-color:#e0e0e0;--card-shadow:0 2px 8px rgba(0,0,0,.08)}body.theme-dark{--primary-color:hsl(var(--theme-hue),80%,60%);--background-color:#121212;--text-color:#e0e0e0;--card-background:#1e1e1e;--card-border-color:#333;--card-shadow:0 4px 12px rgba(0,0,0,.2)}body.theme-light{--theme-hue:207;--background-color:#fff}body.theme-pink{--theme-hue:330}body{font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,sans-serif;padding:0;margin:0;line-height:1.6;background-color:var(--background-color);color:var(--text-color);transition:background-color .3s,color .3s}.container{max-width:800px;margin:0 auto;padding:24px}h1,h2{color:var(--primary-color);text-align:center;margin-bottom:1em}a{color:var(--primary-color);text-decoration:none}.hidden{display:none}.footer{margin-top:48px;border-top:1px solid var(--card-border-color);padding-top:24px;text-align:center;font-size:.9em;color:#888}.theme-switcher{position:absolute;top:15px;right:15px;display:flex;gap:8px}.theme-button{width:24px;height:24px;border-radius:50%;border:2px solid var(--card-border-color);cursor:pointer;transition:transform .2s}.theme-button:hover{transform:scale(1.1)}#btn-blue{background-color:#03a9f4}#btn-dark{background-color:#121212}#btn-light{background-color:#fff}#btn-pink{background-color:#e91e63}.selection-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:20px;margin-top:1em}.selection-card{background-color:var(--card-background);border:2px solid var(--card-border-color);border-radius:12px;padding:16px;text-align:center;cursor:pointer;transition:border-color .3s,box-shadow .3s,transform .2s;box-shadow:var(--card-shadow)}.selection-card:hover{border-color:var(--primary-color);transform:translateY(-4px)}.selection-card.selected{border-color:var(--primary-color);box-shadow:0 0 10px var(--primary-color)}.selection-card img{width:80px;height:80px;object-fit:contain;margin-bottom:12px}.selection-card span{font-weight:500;font-size:1.1em}#version-selection h2{margin-top:1.5em}.version-buttons{display:flex;justify-content:center;flex-wrap:wrap;gap:12px}.version-button{background-color:var(--card-background);border:2px solid var(--primary-color);color:var(--primary-color);padding:10px 20px;border-radius:8px;font-size:1em;font-weight:bold;cursor:pointer;transition:background-color .3s,color .3s}.version-button:hover,.version-button.selected{background-color:var(--primary-color);color:var(--card-background)}.install-button-container{text-align:center;margin-top:40px}.error-message{color:#ff4d4d;background-color:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);padding:10px;border-radius:8px;text-align:left;font-family:monospace;white-space:pre-wrap;word-break:break-all;}
  </style>
</head>
<body class="theme-blue">

  <div class="theme-switcher">
    <!-- ... theme buttons ... -->
  </div>

  <div class="container">
    <h1>动态固件在线安装器 (调试版)</h1>
    
    <div id="project-selection">
      <h2>1. 选择您的项目</h2>
      <div id="project-grid" class="selection-grid"></div>
    </div>
    
    <div id="device-selection" class="hidden">
      <h2>2. 选择您的设备</h2>
      <div id="device-grid" class="selection-grid"></div>
    </div>
    
    <div id="version-selection" class="hidden">
      <!-- ... -->
    </div>
    
    <div id="install-button-container" class="install-button-container hidden">
      <esp-web-install-button></esp-web-install-button>
    </div>

    <div class="footer">
      Installer powered by <a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a>.
    </div>
  </div>

<script>
// --- START: MODIFIED SCRIPT WITH DETAILED ERROR REPORTING ---

const FIRMWARE_BASE_PATH = "firmware";

const projectGrid = document.getElementById('project-grid');
const deviceGrid = document.getElementById('device-grid');
const versionButtons = document.getElementById('version-buttons');
const deviceSelection = document.getElementById('device-selection');
const versionSelection = document.getElementById('version-selection');
const installButtonContainer = document.getElementById('install-button-container');
const installButton = document.querySelector('esp-web-install-button');

let selectedProject = null;
let selectedDevice = null;

// --- 新增：向界面和控制台显示详细错误的辅助函数 ---
function displayError(gridElement, error) {
    const errorMessage = `
      <div class="error-message">
        <strong>加载错误:</strong><br>
        ${error.message}
      </div>`;
    gridElement.innerHTML = errorMessage;
    console.error(error); // 在F12控制台也打印详细错误
}

// 辅助函数：创建卡片
function createCard(id, name, imageUrl) {
  const card = document.createElement('div');
  card.className = 'selection-card';
  card.dataset.id = id;
  card.innerHTML = `<img src="${imageUrl}" alt="${name}"><span>${name}</span>`;
  return card;
}

// 辅助函数：重置步骤
function resetSteps(fromStep) {
  if (fromStep <= 2) {
    deviceSelection.classList.add('hidden');
    deviceGrid.innerHTML = '';
    selectedDevice = null;
  }
  if (fromStep <= 3) {
    versionSelection.classList.add('hidden');
    versionButtons.innerHTML = '';
  }
  installButtonContainer.classList.add('hidden');
}

// 步骤1: 填充项目
async function populateProjects() {
    projectGrid.innerHTML = '<p>正在加载项目...</p>';
    const projectsUrl = `${FIRMWARE_BASE_PATH}/projects.json`; // 注意文件名是否正确
    try {
        const response = await fetch(projectsUrl);
        // 关键改动：在解析JSON前，检查HTTP响应是否成功
        if (!response.ok) {
            throw new Error(`无法加载项目列表: 服务器返回 ${response.status} (Not Found)。\n请检查文件是否存在于: "${projectsUrl}"`);
        }
        
        const projectFolders = await response.json();
        projectGrid.innerHTML = ''; 

        if (projectFolders.length === 0) {
            projectGrid.innerHTML = '<p>没有找到任何项目。请检查 projects.json 文件内容。</p>';
            return;
        }

        for (const folder of projectFolders) {
            const projectConfigUrl = `${FIRMWARE_BASE_PATH}/${folder}/project.json`;
            try {
                const projResponse = await fetch(projectConfigUrl);
                if (!projResponse.ok) {
                   throw new Error(`找不到项目配置文件: ${projectConfigUrl}`);
                }
                const projData = await projResponse.json();

                const card = createCard(folder, projData.name, `${FIRMWARE_BASE_PATH}/${folder}/${projData.image}`);
                card.addEventListener('click', () => {
                    selectedProject = folder;
                    document.querySelectorAll('#project-grid .selection-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    resetSteps(2);
                    populateDevices(projData.devices);
                });
                projectGrid.appendChild(card);
            } catch (innerError) {
                console.warn(innerError); // 在控制台警告单个项目加载失败，但不中断整个流程
            }
        }
    } catch (error) {
        // --- 关键改动：在这里将详细错误信息显示在界面上 ---
        displayError(projectGrid, error);
    }
}

// 步骤2: 填充设备
async function populateDevices(deviceFolders) {
    deviceGrid.innerHTML = '<p>正在加载设备...</p>';
    deviceSelection.classList.remove('hidden');

    if (!deviceFolders || deviceFolders.length === 0) {
        deviceGrid.innerHTML = '<p>该项目下没有可用的设备。</p>';
        return;
    }
    
    let devicesLoaded = false;
    for (const folder of deviceFolders) {
        const deviceConfigUrl = `${FIRMWARE_BASE_PATH}/${selectedProject}/${folder}/device.json`;
        try {
            const devResponse = await fetch(deviceConfigUrl);
            if (!devResponse.ok) {
                throw new Error(`找不到设备配置文件: 服务器返回 ${devResponse.status}。\n请检查文件是否存在于: "${deviceConfigUrl}"`);
            }

            const devData = await devResponse.json();

            if (!devicesLoaded) {
                deviceGrid.innerHTML = ''; 
                devicesLoaded = true;
            }

            const card = createCard(folder, devData.name, `${FIRMWARE_BASE_PATH}/${selectedProject}/${folder}/${devData.image}`);
            card.addEventListener('click', () => {
                selectedDevice = folder;
                document.querySelectorAll('#device-grid .selection-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                resetSteps(3);
                populateVersions(devData.versions);
            });
            deviceGrid.appendChild(card);
        } catch(error) {
             // --- 关键改动：如果单个设备加载失败，也在界面上显示错误 ---
             displayError(deviceGrid, error);
             return; // 中断加载，因为路径可能已经错了
        }
    }
}

// 步骤3: 填充版本 (代码无改动，因为这里不涉及网络请求)
function populateVersions(versionFolders) {
    // ...
    versionButtons.innerHTML = '';
    versionSelection.classList.remove('hidden');

    if (!versionFolders || versionFolders.length === 0) {
        versionButtons.innerHTML = `<p style="text-align: center; color: #888;">该设备下没有可用的固件版本。</p>`;
        return;
    }

    for (const folder of versionFolders) {
        const button = document.createElement('button');
        button.className = 'version-button';
        button.textContent = folder;
        
        button.addEventListener('click', () => {
            document.querySelectorAll('#version-buttons .version-button').forEach(b => b.classList.remove('selected'));
            button.classList.add('selected');

            const manifestPath = `${FIRMWARE_BASE_PATH}/${selectedProject}/${selectedDevice}/${folder}/manifest.json`;
            installButton.manifest = manifestPath;
            installButtonContainer.classList.remove('hidden');
        });
        versionButtons.appendChild(button);
    }
}


// 主题切换逻辑
document.addEventListener('DOMContentLoaded', populateProjects);
// ... 您原来的主题切换代码可以放在这里
// --- END: MODIFIED SCRIPT ---
</script>
</body>
</html>