<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>动态固件在线安装器</title>
  <meta name="description" content="一个基于文件夹结构动态加载的网页固件安装程序。" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />

  <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>

  <style>
    /* --- CSS 变量，用于主题切换 --- */
    :root {
      --theme-hue: 207; /* 蓝色 HUE 值 */
      --primary-color: hsl(var(--theme-hue), 95%, 50%);
      --background-color: #f0f4f8;
      --text-color: #333;
      --card-background: #ffffff;
      --card-border-color: #e0e0e0;
      --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    body.theme-dark {
      --primary-color: hsl(var(--theme-hue), 80%, 60%);
      --background-color: #121212;
      --text-color: #e0e0e0;
      --card-background: #1e1e1e;
      --card-border-color: #333;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    body.theme-light {
      --theme-hue: 207; /* Blue */
      --background-color: #ffffff;
    }
    body.theme-pink {
      --theme-hue: 330; /* Pink */
    }

    /* --- 基础样式 --- */
    body {
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI",
        Roboto, Ubuntu, sans-serif;
      padding: 0;
      margin: 0;
      line-height: 1.6;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
    }
    h1, h2 {
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 1em;
    }
    a {
      color: var(--primary-color);
      text-decoration: none;
    }
    .hidden {
      display: none;
    }
    .footer {
      margin-top: 48px;
      border-top: 1px solid var(--card-border-color);
      padding-top: 24px;
      text-align: center;
      font-size: 0.9em;
      color: #888;
    }
    
    /* --- 主题切换器 --- */
    .theme-switcher {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      gap: 8px;
    }
    .theme-button {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--card-border-color);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .theme-button:hover {
      transform: scale(1.1);
    }
    #btn-blue { background-color: #03a9f4; }
    #btn-dark { background-color: #121212; }
    #btn-light { background-color: #ffffff; }
    #btn-pink { background-color: #e91e63; }

    /* --- 选择区域样式 --- */
    .selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 20px;
      margin-top: 1em;
    }
    .selection-card {
      background-color: var(--card-background);
      border: 2px solid var(--card-border-color);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.3s, box-shadow 0.3s, transform 0.2s;
      box-shadow: var(--card-shadow);
    }
    .selection-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-4px);
    }
    .selection-card.selected {
      border-color: var(--primary-color);
      box-shadow: 0 0 10px var(--primary-color);
    }
    .selection-card img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin-bottom: 12px;
    }
    .selection-card span {
      font-weight: 500;
      font-size: 1.1em;
    }

    /* --- 版本和安装按钮 --- */
    #version-selection h2 { margin-top: 1.5em; }
    .version-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .version-button {
        background-color: var(--card-background);
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s;
    }
    .version-button:hover, .version-button.selected {
        background-color: var(--primary-color);
        color: var(--card-background);
    }

    .install-button-container {
      text-align: center;
      margin-top: 40px;
    }
  </style>
</head>
<body class="theme-blue">

  <div class="theme-switcher">
    <div class="theme-button" id="btn-blue" title="蓝色主题"></div>
    <div class="theme-button" id="btn-dark" title="深色主题"></div>
    <div class="theme-button" id="btn-light" title="浅色主题"></div>
    <div class="theme-button" id="btn-pink" title="粉色主题"></div>
  </div>

  <div class="container">
    <h1>动态固件在线安装器</h1>

    <!-- 步骤1: 选择项目 -->
    <div id="project-selection">
      <h2>1. 选择您的项目</h2>
      <div id="project-grid" class="selection-grid"></div>
    </div>

    <!-- 步骤2: 选择设备 -->
    <div id="device-selection" class="hidden">
      <h2>2. 选择您的设备</h2>
      <div id="device-grid" class="selection-grid"></div>
    </div>

    <!-- 步骤3: 选择版本 -->
    <div id="version-selection" class="hidden">
      <h2>3. 选择固件版本</h2>
      <div id="version-buttons" class="version-buttons"></div>
    </div>
    
    <!-- 步骤4: 连接并安装 -->
    <div id="install-button-container" class="install-button-container hidden">
        <esp-web-install-button></esp-web-install-button>
    </div>

    <div class="footer">
      Installer powered by <a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a>.
    </div>
  </div>

<script>
const FIRMWARE_BASE_PATH = "firmware";

// --- 获取页面元素 ---
const projectSelection = document.getElementById('project-selection');
const deviceSelection = document.getElementById('device-selection');
const versionSelection = document.getElementById('version-selection');
const installButtonContainer = document.getElementById('install-button-container');

const projectGrid = document.getElementById('project-grid');
const deviceGrid = document.getElementById('device-grid');
const versionButtons = document.getElementById('version-buttons');
const installButton = document.querySelector('esp-web-install-button');

let selectedProject = null;
let selectedDevice = null;

// --- 动态加载和事件处理 ---

// 辅助函数：显示加载指示器或错误信息
function setGridState(gridElement, message) {
    gridElement.innerHTML = `<p style="text-align: center; color: #888;">${message}</p>`;
}

// 辅助函数：创建选择卡片
function createCard(id, name, imageUrl) {
  const card = document.createElement('div');
  card.className = 'selection-card';
  card.dataset.id = id;
  card.innerHTML = `
    <img src="${imageUrl}" alt="${name}" onerror="this.style.display='none'">
    <span>${name}</span>
  `;
  return card;
}

// 辅助函数：重置并隐藏后续步骤
function resetSteps(fromStep) {
  if (fromStep <= 2) {
    deviceSelection.classList.add('hidden');
    deviceGrid.innerHTML = '';
    selectedDevice = null;
  }
  if (fromStep <= 3) {
    versionSelection.classList.add('hidden');
    versionButtons.innerHTML = '';
  }
  installButtonContainer.classList.add('hidden');
}

// 步骤1: 填充项目
async function populateProjects() {
    setGridState(projectGrid, '正在加载项目...');
    try {
        const response = await fetch(`${FIRMWARE_BASE_PATH}/ALL_Project.json`);
        if (!response.ok) throw new Error(`找不到 ALL_Project.json (HTTP ${response.status})`);
        const projectFolders = await response.json();

        projectGrid.innerHTML = ''; // 清空加载信息
        if (projectFolders.length === 0) {
            setGridState(projectGrid, '没有找到任何项目。');
            return;
        }

        for (const folder of projectFolders) {
            const projResponse = await fetch(`${FIRMWARE_BASE_PATH}/${folder}/Project.json`);
            if (!projResponse.ok) continue; // 如果项目配置文件不存在，则跳过
            const projData = await projResponse.json();

            const card = createCard(folder, projData.name, `${FIRMWARE_BASE_PATH}/${folder}/${projData.image}`);
            card.addEventListener('click', () => {
                selectedProject = folder;
                document.querySelectorAll('#project-grid .selection-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                resetSteps(2);
                populateDevices(projData.devices);
            });
            projectGrid.appendChild(card);
        }
    } catch (error) {
        setGridState(projectGrid, `错误: ${error.message}。请检查您的文件结构和JSON文件，并确保服务器已正确启动。`);
    }
}

// 步骤2: 填充设备
async function populateDevices(deviceFolders) {
    setGridState(deviceGrid, '正在加载设备...');
    deviceSelection.classList.remove('hidden');

    if (!deviceFolders || deviceFolders.length === 0) {
        setGridState(deviceGrid, '该项目下没有可用的设备。');
        return;
    }

    let devicesLoaded = false;
    for (const folder of deviceFolders) {
        const devResponse = await fetch(`${FIRMWARE_BASE_PATH}/${selectedProject}/${folder}/device.json`);
        if (!devResponse.ok) continue;
        const devData = await devResponse.json();
        
        if (!devicesLoaded) {
            deviceGrid.innerHTML = ''; // 首次成功加载时，清除“加载中”
            devicesLoaded = true;
        }

        const card = createCard(folder, devData.name, `${FIRMWARE_BASE_PATH}/${selectedProject}/${folder}/${devData.image}`);
        card.addEventListener('click', () => {
            selectedDevice = folder;
            document.querySelectorAll('#device-grid .selection-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            resetSteps(3);
            populateVersions(devData.versions);
        });
        deviceGrid.appendChild(card);
    }
    
    if (!devicesLoaded) {
        setGridState(deviceGrid, '未能加载任何设备信息。');
    }
}

// 步骤3: 填充版本
function populateVersions(versionFolders) {
    versionButtons.innerHTML = '';
    versionSelection.classList.remove('hidden');

    if (!versionFolders || versionFolders.length === 0) {
        versionButtons.innerHTML = `<p style="text-align: center; color: #888;">该设备下没有可用的固件版本。</p>`;
        return;
    }

    for (const folder of versionFolders) {
        const button = document.createElement('button');
        button.className = 'version-button';
        button.textContent = folder;
        
        button.addEventListener('click', () => {
            document.querySelectorAll('#version-buttons .version-button').forEach(b => b.classList.remove('selected'));
            button.classList.add('selected');

            // 构造 manifest 文件的最终路径
            const manifestPath = `${FIRMWARE_BASE_PATH}/${selectedProject}/${selectedDevice}/${folder}/manifest.json`;
            installButton.manifest = manifestPath;
            installButtonContainer.classList.remove('hidden');
        });
        versionButtons.appendChild(button);
    }
}

// --- 主题切换逻辑 ---
document.getElementById('btn-blue').addEventListener('click', () => { document.body.className = 'theme-blue'; });
document.getElementById('btn-dark').addEventListener('click', () => { document.body.className = 'theme-dark'; });
document.getElementById('btn-light').addEventListener('click', () => { document.body.className = 'theme-light'; });
document.getElementById('btn-pink').addEventListener('click', () => { document.body.className = 'theme-pink'; });

// --- 初始化 ---
document.addEventListener('DOMContentLoaded', populateProjects);
</script>
</body>
</html>