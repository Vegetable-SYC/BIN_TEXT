<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-t" />
  <title>动态固件在线安装器 (v2)</title>
  <meta name="description" content="一个基于文件夹结构动态加载的网页固件安装程序。" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />

  <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>

  <style>
    /* --- CSS 变量，用于主题切换 --- */
	:root {
	  /* 预定义色调，方便管理 */
	  --hue-blue: 207;
	  --hue-pink: 330;
	  
	  /* 默认/备用值 (初始加载时使用蓝色主题) */
	  --theme-hue: var(--hue-blue); 
	  --primary-color: hsl(var(--theme-hue), 95%, 50%);
	  --background-color: #f0f4f8;
	  --text-color: #333;
	  --card-background: #ffffff;
	  --card-border-color: #e0e0e0;
	  --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
	}

	/* --- 主题定义 --- */

	/* 深色主题 */
	body.theme-dark {
	  --primary-color: hsl(var(--theme-hue), 80%, 60%); /* 在深色背景下，颜色可以更亮一些 */
	  --background-color: #121212;
	  --text-color: #e0e0e0;
	  --card-background: #1e1e1e;
	  --card-border-color: #333;
	  --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
	}

	/* 蓝色主题 (基于浅色) - 显式定义 */
	body.theme-blue {
	  --theme-hue: var(--hue-blue);
	  --primary-color: hsl(var(--theme-hue), 95%, 50%);
	  --background-color: #f0f4f8; /* 默认的浅灰色背景 */
	  --text-color: #333;
	  --card-background: #ffffff;
	  --card-border-color: #e0e0e0;
	  --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
	}

	/* 浅色主题 (纯白背景) */
	body.theme-light {
	  --theme-hue: var(--hue-blue); /* 浅色主题使用蓝色作为主色调 */
	  --primary-color: hsl(var(--theme-hue), 95%, 50%);
	  --background-color: #ffffff; /* 纯白色背景 */
	  --text-color: #333;
	  --card-background: #ffffff;
	  --card-border-color: #e0e0e0;
	  --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
	}

	/* 粉色主题 (基于浅色) - 补充完整定义 */
	body.theme-pink {
	  --theme-hue: var(--hue-pink);
	  --primary-color: hsl(var(--theme-hue), 95%, 50%);
	  --background-color: #f0f4f8; /* 和蓝色主题使用相同的背景，以保持一致 */
	  --text-color: #333;
	  --card-background: #ffffff;
	  --card-border-color: #e0e0e0;
	  --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
	}
    /* --- 基础样式 --- */
    body {
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI",
        Roboto, Ubuntu, sans-serif;
      padding: 0;
      margin: 0;
      line-height: 1.6;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
    }
    h1, h2 {
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 1em;
    }
    a {
      color: var(--primary-color);
      text-decoration: none;
    }
    .hidden {
      display: none;
    }
    .footer {
      margin-top: 48px;
      border-top: 1px solid var(--card-border-color);
      padding-top: 24px;
      text-align: center;
      font-size: 0.9em;
      color: #888;
    }
    .theme-switcher {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      gap: 8px;
    }
    .theme-button {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--card-border-color);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .theme-button:hover {
      transform: scale(1.1);
    }
    #btn-blue { background-color: #03a9f4; }
    #btn-dark { background-color: #121212; }
    #btn-light { background-color: #ffffff; }
    #btn-pink { background-color: #e91e63; }
    .selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      margin-top: 1em;
    }
    
    /* --- [排版修复] 修改 .selection-card 样式 --- */
    .selection-card {
      background-color: var(--card-background);
      border: 2px solid var(--card-border-color);
      border-radius: 12px;
      padding: 20px 16px;
      cursor: pointer;
      transition: border-color 0.3s, box-shadow 0.3s, transform 0.2s;
      box-shadow: var(--card-shadow);

      /* 使用 Flexbox 实现垂直和水平居中 */
      display: flex;
      flex-direction: column; /* 垂直排列 */
      justify-content: center; /* 垂直居中 */
      align-items: center;    /* 水平居中 */
      gap: 12px; /* 图片和文字之间的间距 */
    }
    .selection-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-4px);
    }
    .selection-card.selected {
      border-color: var(--primary-color);
      box-shadow: 0 0 10px var(--primary-color);
    }
    .selection-card img {
      width: 80px;
      height: 80px;
      object-fit: contain;
    }
    .selection-card span {
      font-weight: 500;
      font-size: 1.1em;
      text-align: center; /* 确保长文本也能居中 */
    }
    
    /* --- 版本按钮和安装按钮样式 --- */
    #version-selection h2 {
      margin-top: 1.5em;
    }
    .version-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .version-button {
      background-color: var(--card-background);
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
    }
    .version-button:hover, .version-button.selected {
      background-color: var(--primary-color);
      color: var(--card-background);
    }
    .install-button-container {
      text-align: center;
      margin-top: 40px;
    }
    .error-message {
      color: #ff4d4d;
      background-color: rgba(255, 77, 77, 0.1);
      border: 1px solid rgba(255, 77, 77, 0.3);
      padding: 10px;
      border-radius: 8px;
      text-align: left;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
  </style>
</head>
<body class="theme-blue">

  <div class="theme-switcher">
    <div class="theme-button" id="btn-blue" title="蓝色主题"></div>
    <div class="theme-button" id="btn-dark" title="深色主题"></div>
    <div class="theme-button" id="btn-light" title="浅色主题"></div>
    <div class="theme-button" id="btn-pink" title="粉色主题"></div>
  </div>

  <div class="container">
    <h1>动态固件在线安装器</h1>
    <div id="project-selection">
      <h2>1. 选择您的项目</h2>
      <div id="project-grid" class="selection-grid"></div>
    </div>
    <div id="device-selection" class="hidden">
      <h2>2. 选择您的设备</h2>
      <div id="device-grid" class="selection-grid"></div>
    </div>
    <div id="version-selection" class="hidden">
      <h2>3. 选择固件版本</h2>
      <div id="version-buttons" class="version-buttons"></div>
    </div>
    <div id="install-button-container" class="install-button-container hidden">
        <esp-web-install-button></esp-web-install-button>
    </div>
    <div class="footer">
      Installer powered by <a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a>.
    </div>
  </div>

<script>
const FIRMWARE_BASE_PATH = "firmware";

const projectGrid = document.getElementById('project-grid');
const deviceGrid = document.getElementById('device-grid');
const versionButtons = document.getElementById('version-buttons');
const deviceSelection = document.getElementById('device-selection');
const versionSelection = document.getElementById('version-selection');
const installButtonContainer = document.getElementById('install-button-container');
const installButton = document.querySelector('esp-web-install-button');

let selectedProject = null;
let selectedDevice = null;

function displayError(gridElement, error) {
    const errorMessage = `<div class="error-message"><strong>加载错误:</strong><br>${error.message}</div>`;
    gridElement.innerHTML = errorMessage;
    console.error(error);
}

function createCard(id, name, imageUrl) {
  const card = document.createElement('div');
  card.className = 'selection-card';
  card.dataset.id = id;
  card.innerHTML = `<img src="${imageUrl}" alt="${name}"><span>${name}</span>`;
  return card;
}

function resetSteps(fromStep) {
  if (fromStep <= 2) {
    deviceSelection.classList.add('hidden');
    deviceGrid.innerHTML = '';
    selectedDevice = null;
  }
  if (fromStep <= 3) {
    versionSelection.classList.add('hidden');
    versionButtons.innerHTML = '';
  }
  installButtonContainer.classList.add('hidden');
}

async function populateProjects() {
    projectGrid.innerHTML = '<p>正在加载项目...</p>';
    const projectsUrl = `${FIRMWARE_BASE_PATH}/ALL_Project.json`;
    try {
        const response = await fetch(projectsUrl);
        if (!response.ok) {
            throw new Error(`无法加载项目列表: 服务器返回 ${response.status} (Not Found)。\n请检查文件是否存在于: "${projectsUrl}"`);
        }
        
        const projectFolders = await response.json();
        projectGrid.innerHTML = ''; 

        if (projectFolders.length === 0) {
            projectGrid.innerHTML = '<p>没有找到任何项目。请检查 ALL_Project.json 文件内容。</p>';
            return;
        }

        for (const folder of projectFolders) {
            const projectConfigUrl = `${FIRMWARE_BASE_PATH}/${folder}/Project.json`;
            try {
                const projResponse = await fetch(projectConfigUrl);
                if (!projResponse.ok) {
                   throw new Error(`找不到项目配置文件: ${projectConfigUrl}`);
                }
                const projData = await projResponse.json();

                const card = createCard(folder, projData.name, `${FIRMWARE_BASE_PATH}/${folder}/${projData.image}`);
                card.addEventListener('click', () => {
                    selectedProject = folder;
                    document.querySelectorAll('#project-grid .selection-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    resetSteps(2);
                    populateDevices(projData.devices);
                });
                projectGrid.appendChild(card);
            } catch (innerError) {
                console.warn(`跳过项目 "${folder}"，因为它加载失败:`, innerError);
            }
        }
    } catch (error) {
        displayError(projectGrid, error);
    }
}

async function populateDevices(deviceFolders) {
    deviceGrid.innerHTML = '<p>正在加载设备...</p>';
    deviceSelection.classList.remove('hidden');

    if (!deviceFolders || deviceFolders.length === 0) {
        deviceGrid.innerHTML = '<p>该项目下没有可用的设备。</p>';
        return;
    }
    
    let devicesLoaded = false;
    for (const folder of deviceFolders) {
        const deviceConfigUrl = `${FIRMWARE_BASE_PATH}/${selectedProject}/${folder}/Device.json`;
        try {
            const devResponse = await fetch(deviceConfigUrl);
            if (!devResponse.ok) {
                throw new Error(`找不到设备配置文件: 服务器返回 ${devResponse.status}。<br>请检查文件是否存在于: "${deviceConfigUrl}"`);
            }
            const devData = await devResponse.json();

            if (!devicesLoaded) {
                deviceGrid.innerHTML = ''; 
                devicesLoaded = true;
            }
            const card = createCard(folder, devData.name, `${FIRMWARE_BASE_PATH}/${selectedProject}/${folder}/${devData.image}`);
            card.addEventListener('click', () => {
                selectedDevice = folder;
                document.querySelectorAll('#device-grid .selection-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                resetSteps(3);
                populateVersions(devData.versions);
            });
            deviceGrid.appendChild(card);
        } catch(error) {
             displayError(deviceGrid, error);
             return; 
        }
    }

    if (!devicesLoaded) {
         deviceGrid.innerHTML = '<p>未能加载任何设备信息。</p>';
    }
}

function populateVersions(versionFolders) {
    versionButtons.innerHTML = '';
    versionSelection.classList.remove('hidden');

    if (!versionFolders || versionFolders.length === 0) {
        versionButtons.innerHTML = `<p style="text-align: center; color: #888;">该设备下没有可用的固件版本。</p>`;
        return;
    }

    for (const folder of versionFolders) {
        const button = document.createElement('button');
        button.className = 'version-button';
        button.textContent = folder;
        
        button.addEventListener('click', () => {
            document.querySelectorAll('#version-buttons .version-button').forEach(b => b.classList.remove('selected'));
            button.classList.add('selected');

            const manifestPath = `${FIRMWARE_BASE_PATH}/${selectedProject}/${selectedDevice}/${folder}/Download.json`;
            installButton.manifest = manifestPath;
            installButtonContainer.classList.remove('hidden');
        });
        versionButtons.appendChild(button);
    }
}


// --- [主题修复] 主题切换逻辑 ---
function initializeThemes() {
    const savedTheme = localStorage.getItem('firmware-installer-theme') || 'theme-blue';
    document.body.className = savedTheme;

    function setTheme(themeName) {
        document.body.className = themeName;
        localStorage.setItem('firmware-installer-theme', themeName);
    }

    document.getElementById('btn-blue').addEventListener('click', () => setTheme('theme-blue'));
    document.getElementById('btn-dark').addEventListener('click', () => setTheme('theme-dark'));
    document.getElementById('btn-light').addEventListener('click', () => setTheme('theme-light'));
    document.getElementById('btn-pink').addEventListener('click', () => setTheme('theme-pink'));
}

// --- 初始化 ---
document.addEventListener('DOMContentLoaded', () => {
    initializeThemes();
    populateProjects();
});

</script>
</body>
</html>